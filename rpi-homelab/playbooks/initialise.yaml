# initialise.yaml
# https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#initializing-your-control-plane-node
---
- name: Initialise the control-plane node
  become: true
  hosts: main
  tasks:
    - name: Run 'kubeadm init' on the control-plane node
      ansible.builtin.command: kubeadm init --pod-network-cidr=192.168.27.0/24
      register: kubeadm_init
      changed_when: false
      tags: [cp_only]

    - name: Run regexes and set 'kubeadm join' command as fact
      ansible.builtin.set_fact:
        kubeadm_join: "{{ kubeadm_init.stdout | regex_search(regexp,'\\1') | regex_replace(' \\\\+n +', ' ') }}"
      vars:
        regexp: "(?is)(kubeadm join .*)"

- name: Install a Pod network add-on
  become: true
  hosts: main
  tasks:
    - name: Get Calico manifest
      ansible.builtin.get_url:
        url: https://docs.projectcalico.org/manifests/calico.yaml
        dest: /tmp/calico.yaml

    - name: Install openshift Python package
      ansible.builtin.pip:
        name: openshift

    - name: Apply Calico manifest to the cluster
      community.kubernetes.k8s:
        src: /tmp/calico.yaml
        state: present
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    # vvv - TODO: candidate for removal; keep an eye on the GH issue - vvv

    - name: Patch to resolve iptables issue - https://github.com/projectcalico/calico/issues/4487
      community.kubernetes.k8s:
        state: present
        resource_definition:
          apiVersion: crd.projectcalico.org/v1
          kind: FelixConfiguration
          metadata:
            name: default
            namespace: default
          spec:
            iptablesBackend: Legacy
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    # ^^^ - TODO: candidate for removal; keep an eye on the GH issue - ^^^

- name: Join worker nodes to cluster
  become: true
  hosts: workers
  tasks:
    - name: Run 'kubeadm join' on workers
      ansible.builtin.command: "{{ hostvars['main']['kubeadm_join'][0] }}"

- name: De-taint control plane
  become: true
  hosts: main
  tasks:
    - name: De-taint control plane
      ansible.builtin.command: kubectl taint nodes --all node-role.kubernetes.io/master-
      changed_when: false
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

- name: Retrieve kubeconfig to local
  become: true
  hosts: main
  tags: [cp_only]
  tasks:
    - name: Generate kubectl credential from main
      ansible.builtin.shell: >-
        kubeadm alpha kubeconfig user
        --client-name=jltykmbp --config=
        >>
        "{{ kubeconfig_filename }}"

    - name: Set temporary kubeconfig filename as fact
      ansible.builtin.set_fact:
        kubeconfig_filename: "/tmp/rpi-kubeconfig.{{ ansible_date_time.iso8601 }}.yaml"

    - name: Fetch kubeconfig from CP into local file
      ansible.builtin.fetch:
        src: "{{ kubeconfig_filename }}"
        dest: "{{ kubeconfig_filename }}"
